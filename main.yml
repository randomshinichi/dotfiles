---
- hosts: maincomputer
  remote_user: root
  vars:
    username: shinichi
  tasks:
    - name: Add repositories for non-standard software
      apt_repository:
        repo: ppa:unit193/encryption
        state: present

    - name: apt update
      apt: update_cache=yes

    - name: Install Basics
      apt: name={{ item }} state=latest
      with_items:
        - ansible
        - aptitude
        - build-essential
        - chromium-browser
        - curl
        # - dropbox  # not in standard repo!
        - emacs
        - exfat-fuse
        - feh
        - firefox
        - git
        - golang-go
        - htop
        - hugo
        - i3
        - iftop
        - net-tools  # arp, ifconfig, netstat, route
        - physlock  # the only screen locker that won't let you switch to VTs
        - powertop
        - printer-driver-cups-pdf  # print to pdf
        - quodlibet  # good replacement for fb2k
        - ranger
        - redshift
        - redshift-gtk
        - scrot
        - snapper  # for btrfs root filesystem snapshots
        # - veracrypt  # not in standard repo
        - virtualenvwrapper
        - zfsutils-linux

    - name: Create {{ username }}, ensure that he can sudo
      user:
        name: "{{ username }}"
        state: present
        shell: /bin/bash
        groups: sudo

    # Validate the sudoers file before saving
    - name: ensure that {{ username }} can sudo without a password
      lineinfile:
        path: /etc/sudoers
        state: present
        regexp: '^shinichi ALL='
        line: 'shinichi ALL=(ALL) NOPASSWD: ALL'
        validate: '/usr/sbin/visudo -cf %s'

    - name: Customize keyboard Ctrl
      # This should also work for the tty, not just X.
      # ctrl:nocaps because sometimes Caps Lock activates silently when I’m in the lockscreen
      # compose key is a Unix specific key that helps with inputting foreiDgn language alphabets
      # I can’t believe ctrl-alt-backspace is optional
      lineinfile:
        path: /etc/default/keyboard
        state: present
        regexp: '^XKBOPTIONS='
        line: 'XKBOPTIONS="compose:paus,ctrl:nocaps"'
      notify: "dpkg-reconfigure keyboard-configuration"

    - name: Set RTC to local timezone
      # because Windows likes it that way if you dual boot
      shell: timedatectl set-local-rtc 1 --adjust-system-clock

    - name: Customize keyboard turn PrtSc key into Menu key (X11 only)
      # To get rid of the useless PrtSc key on the Thinkpad X230 keyboard. GDM will load ~/.Xmodmap automatically. If it were any other desktop manager I’d have to hack up a lot of scripts.
      lineinfile:
        path: /home/{{ username }}/.Xmodmap
        state: present
        create: yes
        line: 'keycode 107 = Menu'
      tags:
        - dotfiles

    - name: xset m 0 0 in .xprofile to make Trackpoint usable
      # ~/.xprofile (not in ~/.xinitrc because it gets overwritten by something else later)
      # ~/.xprofile should be sourced by GDM, LightDM, LXDM, SDDM.... and if not, you should source it from ~/.xinitrc.
      lineinfile:
        path: /home/{{ username }}/.xprofile
        line: 'xset m 0 0'
        state: present
        regexp: '^xset'
        create: yes
      tags:
        - dotfiles

    - name: .xinitrc to source .xprofile
    # If you're using GDM, you don't need this because .xprofile will be sourced automatically.
    # But even though LightDM is supposed to source .xprofile, it doesn't.
      lineinfile:
        path: /home/{{ username }}/.xinitrc
        line: 'source ~/.xprofile'
        state: present
        create: yes
      tags:
        - dotfiles

    - name: .xinitrc to run Xmodmap
    # If you're using GDM, you don't need this because .Xmodmap will be sourced automatically.
    # But even though LightDM is supposed to source .Xmodmap, it doesn't.
      lineinfile:
        path: /home/{{ username }}/.xinitrc
        line: 'xmodmap -e ~/.Xmodmap'
        state: present
        create: yes
      tags:
        - dotfiles

    - name: copy .bash_profile to ~{{ username }}
      copy:
        src: files/.bash_profile
        dest: /home/{{ username }}/.bash_profile
        owner: "{{ username }}"
        group: "{{ username }}"
        mode: 0644
      tags:
        - dotfiles

    - name: copy .emacs to ~{{ username }}
      copy:
        src: files/.emacs
        dest: /home/{{ username }}/.emacs
        owner: "{{ username }}"
        group: "{{ username }}"
        mode: 0644
      tags:
        - dotfiles

    - name: copy .gitconfig to ~{{ username }}
      copy:
        src: files/.gitconfig
        dest: /home/{{ username }}/.gitconfig
        owner: "{{ username }}"
        group: "{{ username }}"
        mode: 0644
      tags:
        - dotfiles

    - name: copy i3/ to ~{{ username }}/.config/
      copy:
        src: files/i3
        dest: /home/{{ username }}/.config/
        owner: "{{ username }}"
        group: "{{ username }}"
        mode: 0644
      tags:
        - dotfiles

    - name: utilities for i3 desktop
      apt: name={{ item }} state=latest
      with_items:
        - arandr  # a GUI to configure xrandr (very useful)
        - autorandr  # automatically switches between single/multi monitor when plugged/unplugged
        - udiskie  # automatically mounts new disks
        - lxappearance  # gtk engines: makes GTK apps beautiful outside of GTK environment

    - name: Install tlp to manage power
      apt: name={{ item }} state=latest
      with_items:
        - tlp
        - acpi-call-dkms
        - tp-smapi-dkms

    - name: Because we're using btrfs, we have to disable SATA link power management
      lineinfile:
        path: /etc/default/tlp
        regexp: '^SATA_LINKPWR_ON_BAT'
        line: SATA_LINKPWR_ON_BAT="max_performance"

    - name: snap packages
      shell: snap install pycharm-community --classic; snap install goland --classic; snap install sublime-text --classic; snap install slack --classic; snap install discord gitkraken; 
      tags:
        - snap

  handlers:
    - name: dpkg-reconfigure keyboard-configuration
      shell: dpkg-reconfigure -fnoninteractive keyboard-configuration
